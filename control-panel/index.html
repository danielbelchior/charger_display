<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Charger Display</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .log-info { color: green; }
    .log-warning { color: orange; }
    .log-error { color: red; }
    .log-debug { color: gray; }
  </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen bg-gray-100 space-y-6 p-4">

  <!-- Matrix + Status -->
  <div class="flex space-x-6 bg-white p-4 rounded-lg shadow-md">
    <!-- Matrix -->
    <div>
      <h2 class="text-lg font-semibold mb-2">Display</h2>
      <div id="matrix" class="grid grid-cols-8 gap-1"></div>
    </div>

    <!-- Status Info -->
    <div class="space-y-2">
      <h2 class="text-lg font-semibold mb-2">Status</h2>
      <div><strong>Date Time:</strong> <span id="current_time">-</span></div>
      <div><strong>Uptime:</strong> <span id="uptime">-</span></div>
      <div><strong>Wifi Uptime:</strong> <span id="wifi_last_connect_attempt">-</span></div>
      <div><strong>IP Address:</strong> <span id="ip_address">-</span></div>
      <div><strong>HASS Connected:</strong> <span id="ws_connected">-</span></div>
      <div><strong>Free Heap:</strong> <span id="free_heap">-</span></div>

      <!-- Editable Controls -->
      <div>
        <label class="font-semibold">Sensor 1 State:</label>
        <select id="sensor_1_state" class="border rounded p-1">
          <option value="unknown">unknown</option>
          <option value="off">off</option>
          <option value="disconnected">disconnected</option>
          <option value="charging">charging</option>
        </select>
      </div>

      <div>
        <label class="font-semibold">Sensor 2 State:</label>
        <select id="sensor_2_state" class="border rounded p-1">
          <option value="unknown">unknown</option>
          <option value="off">off</option>
          <option value="disconnected">disconnected</option>
          <option value="charging">charging</option>
        </select>
      </div>

      <div>
        <label class="font-semibold">Display Brightness:</label>
        <input id="displayBrightness" type="range" min="1" max="100" class="w-40" />
        <span id="brightnessValue">-</span>
      </div>
    </div>
  </div>

  <!-- Logs -->
  <div class="bg-gray-50 p-2 rounded-lg shadow-md max-w-3xl w-full">
    <h2 class="text-sm font-semibold mb-1">Logs</h2>
    <div id="logs" class="font-mono text-xs space-y-1 max-h-80 overflow-y-auto"></div>
  </div>

  <script>
    let ws;
    let statusInterval;
    let messagesThisSecond = 0;

    function connectWebSocket() {
      ws = new WebSocket("ws://charger.home:81/");

      ws.onopen = () => {
        console.log("✅ WebSocket connected");
        ws.send("status");

        // envia status a cada 1s
        statusInterval = setInterval(() => {
          if (ws.readyState === WebSocket.OPEN) {
            ws.send("status");
          }
        }, 1000);
      };

      ws.onmessage = (event) => {
        messagesThisSecond++;

        try {
          const data = JSON.parse(event.data);

          // Atualizar status readonly
            // Format uptime as days/hours/minutes
            if (typeof data.uptime === "number") {
              const totalSeconds = data.uptime;
              const days = Math.floor(totalSeconds / 86400);
              const hours = Math.floor((totalSeconds % 86400) / 3600);
              const minutes = Math.floor((totalSeconds % 3600) / 60);
              let uptimeStr = "";
              if (days > 0) uptimeStr += `${days}d `;
              if (hours > 0 || days > 0) uptimeStr += `${hours}h `;
              uptimeStr += `${minutes}m`;
              document.getElementById("uptime").textContent = uptimeStr;
            } else {
              document.getElementById("uptime").textContent = "-";
            }

            if (typeof data.wifi_last_connect_attempt === "number") {
              const totalSeconds = data.wifi_last_connect_attempt;
              const days = Math.floor(totalSeconds / 86400);
              const hours = Math.floor((totalSeconds % 86400) / 3600);
              const minutes = Math.floor((totalSeconds % 3600) / 60);
              let uptimeStr = "";
              if (days > 0) uptimeStr += `${days}d `;
              if (hours > 0 || days > 0) uptimeStr += `${hours}h `;
              uptimeStr += `${minutes}m`;
              document.getElementById("wifi_last_connect_attempt").textContent = uptimeStr;
            } else {
              document.getElementById("wifi_last_connect_attempt").textContent = "-";
            }

            document.getElementById("current_time").textContent = data.current_time ?? "-";
            document.getElementById("ip_address").textContent = data.ip_address ?? "-";
            document.getElementById("ws_connected").textContent = data.ws_connected ? "Yes" : "No";
            // Convert free_heap from bytes to KB
            if (typeof data.free_heap === "number") {
              document.getElementById("free_heap").textContent = `${(data.free_heap / 1024).toFixed(1)} KB`;
            } else {
              document.getElementById("free_heap").textContent = data.free_heap ?? "-";
            }

          // Atualizar controles editáveis
          if (data.sensor_1_state) {
            document.getElementById("sensor_1_state").value = data.sensor_1_state;
          }
          if (data.sensor_2_state) {
            document.getElementById("sensor_2_state").value = data.sensor_2_state;
          }
          if (typeof data.displayBrightness !== "undefined") {
            const slider = document.getElementById("displayBrightness");
            slider.value = data.displayBrightness;
            document.getElementById("brightnessValue").textContent = data.displayBrightness;
          }

          // Render Matrix
          const matrixContainer = document.getElementById("matrix");
          matrixContainer.innerHTML = "";
          data.displayArray.forEach(row => {
            row.forEach(colorInt => {
              const r = (colorInt >> 16) & 0xFF;
              const g = (colorInt >> 8) & 0xFF;
              const b = colorInt & 0xFF;
              const cell = document.createElement("div");
              cell.style.backgroundColor = `rgb(${r}, ${g}, ${b})`;
              cell.className = "w-8 h-8 border border-gray-200";
              matrixContainer.appendChild(cell);
            });
          });

          // Render Logs
          const logsContainer = document.getElementById("logs");
          logsContainer.innerHTML = "";
          if (data.logBuffer) {
            data.logBuffer.slice().reverse().forEach(msg => {
              const logLine = document.createElement("div");
              if (msg.includes(" INFO: ")) logLine.className = "log-info";
              else if (msg.includes(" WARNING: ")) logLine.className = "log-warning";
              else if (msg.includes(" ERROR: ")) logLine.className = "log-error";
              else if (msg.includes(" DEBUG: ")) logLine.className = "log-debug";
              logLine.textContent = msg;
              logsContainer.appendChild(logLine);
            });
          }

        } catch (err) {
          console.error("JSON parse error:", err, event.data);
        }
      };

      ws.onclose = () => {
        console.log("⚠️ WebSocket disconnected, retrying in 2s...");
        clearInterval(statusInterval);
        setTimeout(connectWebSocket, 2000);
      };

      ws.onerror = (err) => {
        console.error("❌ WebSocket error:", err);
        ws.close();
      };
    }

    // contador de mensagens por segundo
    // setInterval(() => {
    //   console.log(`📩 Mensagens recebidas no último segundo: ${messagesThisSecond}`);
    //   messagesThisSecond = 0;
    // }, 1000);

    connectWebSocket();

    // Eventos para modificar valores via REST GET
    document.getElementById("sensor_1_state").addEventListener("change", (e) => {
      const val = e.target.value;
      fetch(`http://charger.local/config/update_state/1/${val}`).then(() =>
        console.log("Sensor 1 atualizado:", val)
      );
    });

    document.getElementById("sensor_2_state").addEventListener("change", (e) => {
      const val = e.target.value;
      fetch(`http://charger.local/config/update_state/2/${val}`).then(() =>
        console.log("Sensor 2 atualizado:", val)
      );
    });

    document.getElementById("displayBrightness").addEventListener("input", (e) => {
      const val = e.target.value;
      document.getElementById("brightnessValue").textContent = val;
    });

    document.getElementById("displayBrightness").addEventListener("change", (e) => {
      const val = e.target.value;
      fetch(`http://charger.local/config/display_brightness/${val}`).then(() =>
        console.log("Brilho atualizado:", val)
      );
    });
  </script>

</body>
</html>
